<html>
    
    <!--Author : Luke Park-->

    <head>
        
        <link rel="stylesheet" href="ow.css">
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="ow.js"></script>
        <link href="https://fonts.googleapis.com/css2?family=Cutive+Mono&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
        
        <link rel="icon" type="image/svg+xml" href="ow.svg">
        <link rel="shortcut icon" href="ow.ico">
        
        <title>Overwatch</title>
    
    </head>
    
    <body>
        
        <header>
            
            <logo class="header_text noselect">Overwatch</logo>
            
            <device_status>
                
                <device_warning class="header_text noselect" id="device_warning">
                    
                    <warning_text id="warning_text">
                    
                    </warning_text>
                    
                    <warning id="warning">
                    
                    </warning>
                    
                </device_warning>
                
                <device_count class="header_text noselect" id="device_count">0</device_count>
                
            </device_status>

        </header>
        
        <content id="dashboard">
            
          
            
        </content>
    
    </body>
    
    <script>
        
        const ws = new WebSocket('wss://192.168.0.33:8765/');
        //const ws = new WebSocket('wss:///92.233.34.206:8765/');

        ws.onopen = () => {
            console.log('Connected to WebSocket server, Pinging network...');
            ping_network();
        };

        ws.onmessage = (event) => {
            
            data = JSON.parse(event.data);
            
            //console.log(data);

            var uuid = data["INFO"]["UUID"];
            var ip = data["INFO"]["IP"];
            
            try {
            
                if (data["DISCONNECT"]) {
                    screens[uuid].disconnected();
                    return;
                }

                if (data["CONFIG"]) {

                    var configuration = JSON.parse(data["CONFIG"]);

                    if (!(uuid in screens)) {
                        screens[uuid] = new create_screen(configuration, uuid, ip);
                    }

                    return;

                }

                if (data["MEASUREMENTS"]){

                    var measurements = data["MEASUREMENTS"];

                    var scr = screens[uuid];

                    for (var measurement = 0; measurement < measurements.length; measurement++) {

                        var gpio = Object.keys(measurements[measurement]);
                        var value = measurements[measurement][gpio];

                        if (gpio in scr.digital_switches) {
                            scr.set_switch(gpio, value);
                        }

                        if (gpio in scr.digital_outputs) {
                            scr.set_output(gpio, value);
                        }

                        if (gpio in scr.analog_bars) {
                            scr.set_analog(gpio, value);
                        }

                        if (gpio in scr.analog_pies) {
                            scr.set_pie(gpio, value);
                        }
                        
                        if (gpio in scr.analog_bar_graphs) {
                            scr.add_bar_graph_value(gpio, value);
                        }

                    }

                }

                scr.connected();
                update_connected_devices();
                
            } catch (error) {
                
                var warning = "Couldn't parse JSON from " + ip + ". Mistake in config.h";
                
                if (data["ping_network"]) {
                    console.log("New console connection established.");
                    warning = "New console connected to network"
                }

                
                document.getElementById("warning").innerHTML = warning_svg;
                document.getElementById("warning_text").innerHTML = warning;
                
            } 
            
        };

        ws.onerror = (error) => {
            console.error('WebSocket Error:', error);
        };
        
    </script>

</html>
